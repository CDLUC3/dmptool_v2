
#adds
ALTER TABLE `dmp2`.`institutions` ADD `old_key` INT(11);
ALTER TABLE `dmp2`.`requirements_templates` ADD `old_foreign_key` INT(11);
ALTER TABLE `dmp2`.`resource_contexts` ADD `old_funder_id` INT(11);
ALTER TABLE `dmp2`.`resources` ADD `old_help_text_id` INT(11);
ALTER TABLE `dmp2`.`resources` ADD `old_suggested_answer_id` INT(11);

ALTER TABLE `dmp2`.`resource_contexts` ADD `old_help_text_id` INT(11);
ALTER TABLE `dmp2`.`resource_contexts` ADD `old_suggested_answer_id` INT(11);
ALTER TABLE `dmp2`.`users` ADD `old_user_id` INT(11);
ALTER TABLE `dmp2`.`authentications` ADD `old_user_id` INT(11);

SET SQL_MODE = NO_AUTO_VALUE_ON_ZERO ; # to resolve problems with institution.id = 0
SET SQL_SAFE_UPDATES=0;

TRUNCATE TABLE `dmp2`.`responses`;
INSERT INTO `dmp2`.`responses` (`id` ,`plan_id` ,`requirement_id` ,`label_id` ,`value` ,`created_at` ,`updated_at` )						
SELECT 			`id`, `plan_id`, `question_id`	   ,	NULL   ,`text`, `created_at`, `updated_at`	
FROM `dmp`.`answers`;


TRUNCATE TABLE `dmp2`.`requirements`;
INSERT INTO `dmp2`.`requirements` (`id`, `order`, `text_brief`, `text_full`, `requirement_type`, `obligation`, `default`, `requirements_template_id`, `created_at`, `updated_at`, `ancestry`, `group`)					
SELECT 	`questions`.`id`, `question_order`,`questions`.`text_brief`,`questions`.`text_full`,'text', 'optional'  , NULL	,	`funder_template_id`,`questions`.`created_at`, `questions`.`updated_at`, NULL, NULL
FROM `dmp`.`questions` JOIN `dmp`.`question_templates` 
ON  `dmp`.`questions`.`id` = `dmp`.`question_templates`.`question_id`;


TRUNCATE TABLE `dmp2`.`institutions`;
INSERT INTO `dmp2`.`institutions` (`id`, `full_name`, `nickname`, `desc`, `contact_info`, `contact_email`, `url`, `url_text`, `shib_entity_id`, `shib_domain`, `created_at`, `updated_at`, `logo`, `ancestry`, `deleted_at`)					
SELECT  `id`, `name`, `nickname`, NULL, `contact_info`,`contact_email`, `url`, `url_text`, `shib_entity_id`, `shib_domain`, `created_at`, `updated_at`, NULL, NULL, NULL
FROM `dmp`.`institutions`; 

INSERT INTO `dmp2`.`institutions` (`full_name`, `nickname`, `desc`, `contact_info`, `contact_email`, `url`, `url_text`, `shib_entity_id`, `shib_domain`, `created_at`, `updated_at`, `logo`, `ancestry`, `deleted_at`, `old_key`)					
SELECT  `name`, `name`,`desc`,NULL, NULL,NULL,NULL,NULL,NULL,`created_at`, `updated_at`,NULL,NULL,NULL, `dmp`.`funders`.`id`
FROM `dmp`.`funders`;

TRUNCATE TABLE `dmp2`.`requirements_templates`;
INSERT INTO `dmp2`.`requirements_templates` (`id`, `institution_id`, `name`, `active`, `start_date`, `end_date`, `visibility`, `version`, `review_type`, `created_at`, `updated_at`, `old_foreign_key`)						
SELECT  `id`, NULL, `name`, `active`, `start_date`, `end_date`,'public',NULL,NULL, `created_at`, `updated_at`, `dmp`.`funder_templates`.`funder_id` 
FROM `dmp`.`funder_templates`;

UPDATE `dmp2`.requirements_templates AS r
INNER JOIN `dmp2`.institutions AS i ON i.old_key = r.old_foreign_key
SET r.institution_id = i.id;


TRUNCATE TABLE `dmp2`.`resources`;
INSERT INTO `dmp2`.`resources` (`id`, `resource_type`, 	`value`	, `label`	, `created_at`, `updated_at`, `text`)						
SELECT 			`id`, 	'actionable_url',  `url`	,`desc`		, 	`created_at`, `updated_at`,`desc`	
FROM `dmp`.`resources`;

INSERT INTO `dmp2`.`resources` (`resource_type`, `value`	, `label`	,  `created_at`, `updated_at`, `text`, `old_help_text_id`)						
SELECT 			'expository_guidance',  `help_text`	,' '	, `created_at`, `updated_at`,`help_text`	,  `id`
FROM `dmp`.`help_texts`;

#suggested_answers
INSERT INTO `dmp2`.`resources` (`resource_type`, `value`	, `label`	,  `created_at`, `updated_at`, `text`, `old_help_text_id`, `old_suggested_answer_id`)						
SELECT 			'suggested_response',  `suggested_answer_text`	,' ', `created_at`, `updated_at`,`suggested_answer_text`	,  NULL, `id`
FROM `dmp`.`suggested_answers`;



TRUNCATE TABLE `dmp2`.`resource_contexts`;
INSERT INTO `dmp2`.`resource_contexts` (	`id`, `institution_id`, `requirements_template_id`,  `requirement_id`, `created_at`, `updated_at`, `resource_id`, `old_funder_id`)
SELECT 	`id`,`institution_id` , `funder_template_id`, `question_id`, `created_at`, `updated_at` , `resource_id`, `funder_id`
FROM `dmp`.`resource_contexts`
WHERE `question_id` > 0;

INSERT INTO `dmp2`.`resource_contexts` (	 `institution_id`, `requirements_template_id`, `requirement_id`, `created_at`, `updated_at`, `resource_id`, `old_funder_id`, `old_help_text_id`)						
SELECT 	`ht`.`institution_id` , `qt`.`funder_template_id` , `ht`.`question_id`, `ht`.`created_at`, `ht`.`updated_at` , NULL, NULL, `ht`.`id`
FROM `dmp`.`help_texts` AS ht INNER JOIN `dmp`.`question_templates` AS qt ON ht.question_id = qt.question_id
WHERE `ht`.`question_id` > 0;

INSERT INTO `dmp2`.`resource_contexts` (	 `institution_id`, `requirements_template_id`, `requirement_id`, `created_at`, `updated_at`, `resource_id`, `old_funder_id`, `old_help_text_id`, `old_suggested_answer_id`)						
SELECT 	`sa`.`institution_id` , `qt`.`funder_template_id` , `sa`.`question_id`, `sa`.`created_at`, `sa`.`updated_at` , NULL, NULL, NULL,`sa`.`id`
FROM `dmp`.`suggested_answers` AS sa INNER JOIN `dmp`.`question_templates` AS qt ON sa.question_id = qt.question_id;

# assign resource_id to the help text resources
UPDATE `dmp2`.resource_contexts AS rc
INNER JOIN `dmp2`.resources AS r ON r.old_help_text_id = rc.old_help_text_id
SET rc.resource_id = r.id ;

#if institution is null I insert the new value that corresponds to the old funder_id, if they are both set I insert the institution_id
UPDATE `dmp2`.resource_contexts AS rc
INNER JOIN `dmp2`.institutions AS i ON i.old_key = rc.old_funder_id
SET rc.institution_id = i.id
WHERE rc.institution_id IS NULL;

# assign resource_id to the suggested answer resources
UPDATE `dmp2`.resource_contexts AS rc
INNER JOIN `dmp2`.resources AS r ON r.old_suggested_answer_id = rc.old_suggested_answer_id
SET rc.resource_id = r.id ;




#put negative resource_contexts in additional_info (-1) and sample plans (-2)
TRUNCATE TABLE `dmp2`.`additional_informations`;
INSERT INTO `dmp2`.`additional_informations` ( `url`, `label`, `requirements_template_id`, `created_at`, `updated_at`)					
SELECT `r`.`url`, `r`.`desc`	, `rc`.`funder_template_id`, `r`.`created_at`, `r`.`updated_at`
FROM `dmp`.`resource_contexts` AS rc INNER JOIN `dmp`.`resources` AS r ON  `rc`.`resource_id` = `r`.`id`
WHERE `rc`.`question_id` = -1;

TRUNCATE TABLE `dmp2`.`sample_plans`;
INSERT INTO `dmp2`.`sample_plans` ( `url`, `label`, `requirements_template_id`, `created_at`, `updated_at`)					
SELECT `r`.`url`, `r`.`desc`	, `rc`.`funder_template_id`, `r`.`created_at`, `r`.`updated_at`
FROM `dmp`.`resource_contexts` AS rc INNER JOIN `dmp`.`resources` AS r ON  `rc`.`resource_id` = `r`.`id`
WHERE `rc`.`question_id` = -2;



TRUNCATE TABLE `dmp2`.`users`;
INSERT INTO `dmp2`.`users` (`id`, `institution_id`, `email`, `first_name`, `last_name`, `token`, `token_expiration`, `prefs`, `created_at`, `updated_at`, `login_id`, `active`)						
SELECT 			u.`id`, u.`institution_id`, u.`email`, u.`first_name`, u.`last_name`, u.`token`, u.`token_expiration`,	X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A2066616C73650A20203A64656163746976617465643A2066616C73650A20203A64656C657465643A2066616C73650A20203A6E65775F636F5F6F776E65723A2066616C73650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A'
,  u.`created_at`, u.`updated_at`,  GROUP_CONCAT(DISTINCT a.uid) , 1
FROM `dmp`.`users` AS u LEFT JOIN `dmp`.`authentications` AS a ON u.id = a.user_id 
WHERE a.provider = 'ldap'
GROUP BY a.user_id;


	

INSERT INTO `dmp2`.`users` (`institution_id`, `email`, `first_name`, `last_name`, `token`, `token_expiration`, `prefs`, `created_at`, `updated_at`, `login_id`, `active`, `deleted_at`, `old_user_id`)
VALUES
	(1,'marisa.strong@ucop.edu','Marisa','Strong',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A2066616C73650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A2066616C73650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A2066616C73650A20203A64656163746976617465643A2066616C73650A20203A64656C657465643A2066616C73650A20203A6E65775F636F5F6F776E65723A2066616C73650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A2066616C73650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-09-24 20:53:48','2014-01-14 01:07:27','mstrong',1,NULL, 4),
	(1,'shirin.faenza@ucop.edu','Shirin','Faenza',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A2066616C73650A20203A64656163746976617465643A2066616C73650A20203A64656C657465643A2066616C73650A20203A6E65775F636F5F6F776E65723A2066616C73650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-10-22 20:55:35','2013-11-05 17:50:25','sfaenza',1,NULL, 5),
	(1,'perry.willett@ucop.edu','Perry','Willett',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A20747275650A20203A64656163746976617465643A20747275650A20203A64656C657465643A20747275650A20203A6E65775F636F5F6F776E65723A20747275650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-10-22 22:48:44','2013-12-20 19:57:38','pwillett',1,NULL, 6),
	(1,'scott.fisher@ucop.edu','Scott','Fisher',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A2066616C73650A20203A64656163746976617465643A2066616C73650A20203A64656C657465643A2066616C73650A20203A6E65775F636F5F6F776E65723A2066616C73650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-10-22 23:22:11','2014-01-07 23:47:21','sfisher',1,NULL, 7),
	(1,'bhavi.vedula04@gmail.com','Bhavi','Vedula',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A20747275650A20203A64656163746976617465643A20747275650A20203A64656C657465643A20747275650A20203A6E65775F636F5F6F776E65723A20747275650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-10-28 22:12:01','2013-11-04 08:47:36','bhavi.vedula04',1,NULL, 11),
	(1,'admin123@gmail.com','Admin123','UCOP Admin',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A2066616C73650A20203A64656163746976617465643A2066616C73650A20203A64656C657465643A2066616C73650A20203A6E65775F636F5F6F776E65723A2066616C73650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-11-01 23:46:01','2013-12-11 20:40:29','admin123',1,NULL, 13),
	(1,'resource123@gmail.com','Resource123',NULL,NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A20747275650A20203A64656163746976617465643A20747275650A20203A64656C657465643A20747275650A20203A6E65775F636F5F6F776E65723A20747275650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-11-01 23:46:51','2013-12-20 21:32:03','resource123',1,NULL, 14),
	(1,'require123@gmail.com','Require123',NULL,NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A20747275650A20203A64656163746976617465643A20747275650A20203A64656C657465643A20747275650A20203A6E65775F636F5F6F776E65723A20747275650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-11-01 23:47:12','2013-11-05 17:33:48','require123',1,NULL, 15),
	(1,'instrev123@gmail.com','Instrev123',NULL,NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A20747275650A20203A64656163746976617465643A20747275650A20203A64656C657465643A20747275650A20203A6E65775F636F5F6F776E65723A20747275650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-11-01 23:47:37','2013-11-05 15:20:10','instrev123',1,NULL, 16),
	(1,'instadmin123@gmail.com','Instadmin123','',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A2066616C73650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A2066616C73650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A2066616C73650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A2066616C73650A20203A64656163746976617465643A2066616C73650A20203A64656C657465643A2066616C73650A20203A6E65775F636F5F6F776E65723A2066616C73650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-11-01 23:48:06','2014-01-07 22:21:56','instadmin123',1,NULL, 17),
	(1,'esatzman@ucop.edu',' ',' ',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A20747275650A20203A64656163746976617465643A20747275650A20203A64656C657465643A20747275650A20203A6E65775F636F5F6F776E65723A20747275650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-11-04 21:58:34','2013-11-04 21:58:34','esatzman',1,NULL, 18),
	(1,'daniel.laing@ucop.edu','Daniel','Laing',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A2066616C73650A20203A64656163746976617465643A2066616C73650A20203A64656C657465643A2066616C73650A20203A6E65775F636F5F6F776E65723A2066616C73650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-11-05 17:53:22','2013-11-05 17:54:02','dlaing',1,NULL, 19),
	(1,'carly.strasser@ucop.edu','Carly','Strasser',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A2066616C73650A20203A64656163746976617465643A2066616C73650A20203A64656C657465643A2066616C73650A20203A6E65775F636F5F6F776E65723A2066616C73650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-11-05 22:37:14','2014-01-14 01:14:41','cstrasser',1,NULL, 23),
	(1,'test_user2@gmail.com','Test','User2',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A2066616C73650A20203A64656163746976617465643A2066616C73650A20203A64656C657465643A2066616C73650A20203A6E65775F636F5F6F776E65723A2066616C73650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-11-12 22:22:19','2014-01-07 22:20:29','test_user2',1,NULL, 27),
	(1,'stephen.abrams@ucop.edu','Stephen','Abrams',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A20747275650A20203A64656163746976617465643A20747275650A20203A64656C657465643A20747275650A20203A6E65775F636F5F6F776E65723A20747275650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-11-21 20:36:46','2013-11-21 20:36:46','slabrams',1,NULL, 41),	
	(1,'patricia.cruse@ucop.edu','Patricia','Cruse',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A2066616C73650A20203A64656163746976617465643A2066616C73650A20203A64656C657465643A2066616C73650A20203A6E65775F636F5F6F776E65723A2066616C73650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-12-04 18:13:37','2014-01-02 18:46:14','pcruse',1,NULL, 49),
	(1,'Carly.Strasser@ucop.edu',NULL,NULL,NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A20747275650A20203A64656163746976617465643A20747275650A20203A64656C657465643A20747275650A20203A6E65775F636F5F6F776E65723A20747275650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2013-12-17 17:52:39','2013-12-17 17:52:39','Carly.Strasser-ucop.edu@ucop.edu',1,NULL, 89),
	(1,'Rosalie.Lack@ucop.edu','Rosalie','Lack',NULL,NULL,X'2D2D2D0A3A75736572733A0A20203A726F6C655F6772616E7465643A20747275650A3A646D705F6F776E6572735F616E645F636F3A0A20203A6E65775F636F6D6D656E743A20747275650A20203A636F6D6D697465643A20747275650A20203A7075626C69736865643A20747275650A20203A7375626D69747465643A20747275650A3A646D705F636F3A0A20203A7375626D69747465643A2066616C73650A20203A64656163746976617465643A2066616C73650A20203A64656C657465643A2066616C73650A20203A6E65775F636F5F6F776E65723A2066616C73650A3A726571756972656D656E745F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A3A7265736F757263655F656469746F72733A0A20203A636F6D6D697465643A20747275650A20203A6465616374697665643A20747275650A20203A64656C657465643A20747275650A20203A6173736F6369617465645F636F6D6D697465643A20747275650A3A696E737469747574696F6E616C5F7265766965776572733A0A20203A7375626D69747465643A20747275650A20203A6E65775F636F6D6D656E743A20747275650A20203A617070726F7665645F72656A65637465643A20747275650A','2014-01-08 19:31:16','2014-01-08 19:31:43','Rosalie.Lack-ucop.edu@ucop.edu',1,NULL, 91);





TRUNCATE TABLE `dmp2`.`authorizations`;
INSERT INTO `dmp2`.`authorizations` (`role_id`, `user_id`, `created_at`, `updated_at`)
SELECT  	1, `id`, `created_at`, `updated_at` 
FROM  `dmp2`.`users`
WHERE dmp2.users.email = 'admin123@gmail.com';



#migrate data from dmp
TRUNCATE TABLE `dmp2`.`authentications`;
INSERT INTO `dmp2`.`authentications` (`id`, `user_id`, `provider`, `uid`, `created_at`, `updated_at`)						
SELECT  	`id`, `user_id`, `provider`, `uid`, `created_at`, `updated_at`  
FROM `dmp`.`authentications` ;

#instert new users authentications from old_authentications that are not already present in the dmp authentication table
INSERT INTO `dmp2`.`authentications` (`user_id`, `provider`, `uid`, `created_at`, `updated_at`, `old_user_id`)
SELECT  	`u`.`id`, `provider`, `uid`, `oa`.`created_at`, `oa`.`updated_at`, `u`.`old_user_id`  
FROM `dmp2`.`users` AS u LEFT JOIN `dmp2`.`old_authentications` AS oa ON u.old_user_id = oa.user_id 
WHERE NOT EXISTS (SELECT 1
    FROM `dmp2`.`authentications`
    	WHERE `oa`.`uid` = `dmp2`.`authentications`.`uid`
    		AND `oa`.`provider` = `dmp2`.`authentications`.`provider`);





TRUNCATE TABLE `dmp2`.`plans`;
INSERT INTO `dmp2`.`plans` (`id`, `name`, `requirements_template_id`, `solicitation_identifier`, `submission_deadline`, `visibility`, `created_at`, `updated_at`, `current_plan_state_id`)
SELECT `id`, `name`,`funder_template_id`, `solicitation_no`,NULL, 'private',`created_at`, `updated_at`,null
FROM `dmp`.`plans`;

TRUNCATE TABLE `dmp2`.`user_plans`;
INSERT INTO `dmp2`.`user_plans` (`id`, `user_id`, `plan_id`, `owner`, `created_at`, `updated_at`)						
SELECT `id`, `user_id`,`plan_id`,NULL , `created_at`, `updated_at`
FROM `dmp`.`user_plans`;


TRUNCATE TABLE `dmp2`.`plan_states`;
INSERT INTO `dmp2`.`plan_states` (`plan_id`, `state`, `user_id`, `created_at`, `updated_at`)						
SELECT  									`plan_id`, 'new', `user_id`, `created_at`, `updated_at`  
FROM `dmp2`.`user_plans` ;


UPDATE `dmp2`.plans AS p
INNER JOIN `dmp2`.plan_states AS ps ON p.id = ps.plan_id
SET p.current_plan_state_id = ps.id ;



##

ALTER TABLE  dmp2.`institutions` DROP COLUMN `old_key`;
ALTER TABLE dmp2.`requirements_templates` DROP COLUMN `old_foreign_key`;
ALTER TABLE dmp2.`resource_contexts` DROP COLUMN `old_funder_id`;
ALTER TABLE dmp2.`resources` DROP COLUMN `old_help_text_id`;
ALTER TABLE dmp2.`resources` DROP COLUMN `old_suggested_answer_id`;

ALTER TABLE dmp2.`resource_contexts` DROP COLUMN `old_help_text_id`;
ALTER TABLE dmp2.`resource_contexts` DROP COLUMN `old_suggested_answer_id`;
ALTER TABLE dmp2.`users` DROP COLUMN `old_user_id`;
ALTER TABLE dmp2.`authentications` DROP COLUMN `old_user_id`;

